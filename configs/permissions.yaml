# AI Quant Company - 权限配置
# 定义 DM 许可、会议申请资格与审批链

# ============================================
# 通信权限矩阵
# ============================================
communication:
  # DM (1v1 直接消息) 权限
  dm:
    # 董事长（Chairman）的特殊规则
    chairman:
      can_dm_all: true  # 可以 DM 任何人
      receive_dm_from: "all"  # 任何人都可以 DM 董事长
      
    # 部门内通信
    intra_department:
      allowed: true
      description: "同部门成员可以自由 DM"
      
    # 跨部门通信
    cross_department:
      # Lead 之间可以跨部门 DM
      lead_to_lead: true
      # 非 Lead 只能 DM 自己的 Lead
      member_to_cross_lead: false
      # 跨部门 DM 需要通过 Lead 转发
      require_lead_relay: true
      
    # 特殊通信通道（绕过部门限制）
    special_channels:
      # CRO 可以直接联系任何 Lead
      - from: "cro"
        to: "all_leads"
        reason: "风险审查需要"
        
      # Skeptic 可以直接联系研究团队 Lead
      - from: "skeptic"
        to: ["alpha_a_lead", "alpha_b_lead", "head_of_research"]
        reason: "质疑审查需要"
        
      # Data Auditor 可以直接联系数据工程
      - from: "data_quality_auditor"
        to: ["data_engineering_lead"]
        reason: "数据质量审查需要"
        
      # CIO 可以直接联系所有 Lead
      - from: "cio"
        to: "all_leads"
        reason: "投委会协调需要"
        
      # CGO 可以直接联系任何人（治理监督）
      - from: "cgo"
        to: "*"
        reason: "治理监督需要"
        
      # CPO 可以直接联系所有 Lead（组织管理）
      - from: "cpo"
        to: "all_leads"
        reason: "组织管理需要"
        
      # CTO* 可以直接联系技术相关 Lead
      - from: "cto_capability"
        to: ["data_engineering_lead", "backtest_lead", "head_of_research"]
        reason: "能力建设需要"

  # MEMO (结构化备忘录) 权限
  memo:
    # 谁可以发布正式 Memo
    can_publish:
      - role: "lead"
        description: "所有 Lead 可以发布 Memo"
      - role: "specific"
        agents: ["audit_compliance", "data_quality_auditor"]
        description: "审计角色可以发布审计 Memo"
        
    # Memo 分发规则
    distribution:
      # 部门 Memo
      department:
        visibility: "department_and_up"
        description: "部门 Memo 本部门及上级可见"
      # 全公司 Memo
      company_wide:
        requires_approval: true
        approver: "chief_of_staff"
        description: "全公司 Memo 需要 CoS 批准"
      # 董事会 Memo
      board:
        requires_approval: true
        approver: "cio"
        description: "董事会 Memo 需要 CIO 批准"

# ============================================
# 会议申请权限
# ============================================
meeting:
  # 谁可以申请会议
  can_request:
    - role: "lead"
      description: "只有 Lead 级别可以申请会议"
    # 特例：审计可以申请紧急会议
    - role: "specific"
      agents: ["audit_compliance", "cro"]
      condition: "urgent_only"
      description: "审计/CRO 可申请紧急会议"
      
  # 会议类型与权限
  types:
    # 部门内会议
    department:
      max_participants: 5
      duration_limit_minutes: 30
      requires_approval_from: ["chief_of_staff"]
      
    # 跨部门会议
    cross_department:
      max_participants: 8
      duration_limit_minutes: 45
      requires_approval_from: ["chief_of_staff", "cio"]
      
    # 投委会会议
    investment_committee:
      fixed_participants: ["cio", "pm", "head_of_research", "cro"]
      optional_participants: ["alpha_a_lead", "alpha_b_lead", "skeptic"]
      duration_limit_minutes: 60
      requires_approval_from: ["chief_of_staff", "cio"]
      
    # 董事会会议
    board:
      max_participants: 10
      duration_limit_minutes: 90
      requires_approval_from: ["chief_of_staff", "cio", "chairman"]
      risk_level: "H"
      
    # 紧急会议
    emergency:
      bypass_normal_approval: true
      requires_approval_from: ["cro", "chairman"]
      must_document_reason: true

# ============================================
# 审批链配置
# ============================================
approval_chain:
  # 会议审批链
  meeting:
    # 第一步：Chief of Staff 初审
    step_1:
      approver: "chief_of_staff"
      criteria:
        - "必要性：是否必须开会？能否异步解决？"
        - "议程：是否有明确议程？"
        - "参与者：是否都必须参加？"
        - "预算：compute_cost 是否合理？"
      can_reject: true
      can_modify: true
      timeout_hours: 4
      
    # 第二步：CRO 复审（条件触发）
    step_2:
      approver: "cro"
      condition: "涉及风险/资金/上线/生产"
      trigger_keywords:
        - "risk"
        - "production"
        - "launch"
        - "capital"
        - "live"
      criteria:
        - "风险评估是否充分？"
        - "是否有应急预案？"
      can_reject: true
      timeout_hours: 4
      
    # 第三步：CIO 终审
    step_3:
      approver: "cio"
      criteria:
        - "是否符合投资策略方向？"
        - "资源分配是否合理？"
      can_reject: true
      timeout_hours: 8
      
    # 第四步：Chairman 最终批准（仅高风险）
    step_4:
      approver: "chairman"
      condition: "risk_level == 'H' OR meeting_type == 'board'"
      criteria:
        - "是否需要董事会关注？"
      can_reject: true
      timeout_hours: 24

  # 策略上线审批链
  strategy_launch:
    step_1:
      approver: "data_quality_auditor"
      gate: "DATA_GATE"
      veto_power: true
      
    step_2:
      approver: "backtest_lead"
      gate: "BACKTEST_GATE"
      
    step_3:
      approver: "robustness_lab"
      gate: "ROBUSTNESS_GATE"
      
    step_4:
      approver: "cro"
      gate: "RISK_SKEPTIC_GATE"
      veto_power: true
      
    step_5:
      approver: "skeptic"
      gate: "RISK_SKEPTIC_GATE"
      can_force_retest: true
      
    step_6:
      approver: "cio"
      gate: "IC_REVIEW"
      
    step_7:
      approver: "chairman"
      gate: "BOARD_DECISION"

# ============================================
# 一票否决权配置
# ============================================
veto_power:
  # 拥有否决权的角色
  holders:
    data_quality_auditor:
      scope: "DATA_GATE"
      description: "数据闸门否决权"
      must_provide_reason: true
      override_by: "chairman"  # 只有董事长可以覆盖
      
    cro:
      scope: "RISK_SKEPTIC_GATE"
      description: "风险闸门否决权"
      must_provide_reason: true
      override_by: "chairman"
      
  # 否决后的流程
  post_veto:
    action: "return_to_previous_gate"
    requires_remediation_plan: true
    cooldown_hours: 24  # 重新提交前的冷却时间

# ============================================
# 强制退回权配置
# ============================================
force_retest:
  # 拥有强制退回权的角色
  holders:
    skeptic:
      description: "可以强制退回要求补实验"
      max_retests_per_strategy: 3
      must_specify_experiments: true
      
  # 退回后的流程
  post_retest:
    return_to: "ROBUSTNESS_GATE"
    requires_specific_experiments: true
    deadline_hours: 48

# ============================================
# 董事长指令 (ChairmanDirective) 权限
# ============================================
chairman_directive:
  # 董事长可以发布的指令类型
  types:
    # 调整目标/约束
    constraint_adjustment:
      examples:
        - "将最大回撤要求从 20% 调整为 15%"
        - "禁止使用某类数据源"
      requires_audit_log: true
      
    # 要求补实验
    request_experiment:
      examples:
        - "必须进行 walk-forward 验证"
        - "必须测试成本翻倍情景"
      requires_audit_log: true
      
    # 调整制度/权重
    policy_adjustment:
      examples:
        - "调整声誉评分权重"
        - "修改预算分配规则"
      requires_audit_log: true
      requires_reason: true
      
    # 冻结/解冻
    freeze_unfreeze:
      examples:
        - "冻结某 Agent"
        - "暂停某策略研究"
      requires_audit_log: true
      requires_reason: true
      
  # 指令不能做的事
  restrictions:
    - "不能直接修改策略参数"
    - "不能绕过闸门审批"
    - "不能删除审计日志"
    
  # 指令格式
  format:
    required_fields:
      - "directive_id"
      - "type"
      - "target"  # 作用对象
      - "content"  # 具体内容
      - "scope"  # 作用范围（某项目/全局）
      - "effective_period"  # 生效期限
      - "reason"  # 原因
    optional_fields:
      - "conditions"  # 触发条件
      - "expiry"  # 过期时间

# ============================================
# 回合制讨论规则
# ============================================
round_based_discussion:
  # 禁止自由群聊
  free_chat_disabled: true
  
  # 回合制流程
  process:
    step_1:
      actor: "lead"
      action: "发布 DiscussionPrompt"
      constraints:
        - "必须有明确问题"
        - "限定回复格式"
        - "设定字数上限"
        
    step_2:
      actor: "team_members"
      action: "分别 DM Lead"
      constraints:
        - "使用结构化输出"
        - "遵守字数限制"
        - "引用证据"
        
    step_3:
      actor: "lead"
      action: "汇总成 TeamSynthesisMemo"
      constraints:
        - "保留原始贡献归属"
        - "不歪曲成员观点"
        - "提交系统存档"
        
  # 审计规则
  audit:
    - "保存每个成员的原始回复"
    - "可追溯 Lead 汇总是否公正"
    - "支持审计回放"

# ============================================
# 工具调用权限
# ============================================
tools:
  # T1: 获取 OHLCV 数据
  "market.get_ohlcv":
    allowed_agents:
      - "alpha_a_*"      # Alpha A 团队
      - "alpha_b_*"      # Alpha B 团队
      - "head_of_research"
      - "data_*"         # 数据部门
      - "backtest_*"     # 回测部门
    allowed_departments:
      - "research_guild"
      - "data_division"
      - "backtest_engine"
    max_limit: 10000
    allowed_timeframes:
      - "1d"
      - "4h"
      - "1h"
    # 1分钟数据需要审批
    restricted_timeframes:
      - timeframe: "1m"
        requires_approval_from: "data_engineering_lead"
    cost_per_1000_rows: 1
    
  # T2: 获取当前报价
  "market.get_quote":
    allowed_agents: ["*"]  # 所有人可用
    cost: 1
    rate_limit:
      requests_per_minute: 30
      
  # T3: 计算技术指标
  "market.compute_indicators":
    allowed_agents:
      - "alpha_a_*"
      - "alpha_b_*"
      - "head_of_research"
      - "backtest_*"
    allowed_departments:
      - "research_guild"
      - "backtest_engine"
    cost_per_indicator: 1
    
  # T4: 运行回测
  "backtest.run":
    allowed_agents:
      - "alpha_a_*"
      - "alpha_b_*"
      - "head_of_research"
      - "backtest_*"
    allowed_departments:
      - "research_guild"
      - "backtest_engine"
    base_cost: 50
    requires_approval_above: 200  # 超过 200 CP 需要审批
    approvers:
      - "head_of_research"
      - "backtest_lead"
    max_robustness_perturbations: 20
    
  # T5: 写入记忆
  "memory.write":
    allowed_agents: ["*"]  # 所有人可用
    scope_approval:
      private: null  # 不需要审批
      team:
        - "team_lead"  # 由组长审批
      org:
        - "chief_of_staff"  # 由 CoS 审批
        - "cro"            # CRO 复审
    content_max_length: 500
    must_have_refs: true  # 必须有引用
    cost: 2
    
  # T6: 搜索记忆
  "memory.search":
    allowed_agents: ["*"]
    scope_visibility:
      private: "self"      # 只能搜索自己的
      team: "team_members" # 可以搜索组内成员的
      org: "all"           # 可以搜索所有人的（已审批的）
    max_top_k: 50
    cost: 1
    
  # T7: 会议展示
  "meeting.present":
    allowed_agents:
      - "*_lead"           # 所有 Lead
      - "head_of_*"        # 所有部门主管
      - "cio"
      - "cro"
    context_required: "meeting"  # 只能在会议中调用
    cost: 5
    max_cards_per_presentation: 10

# ============================================
# 治理与组织权限 (Meta-Governance)
# ============================================
governance:
  # CGO (首席治理官) 权限
  cgo:
    # 冻结权限 - 可以冻结任何 Agent（包括 Lead）
    can_freeze:
      scope: "*"  # 所有 Agent
      requires_evidence: true
      requires_reason: true
      max_duration_hours: 720  # 最长 30 天
      
    # 审计权限
    can_audit:
      scope: "*"  # 所有 Agent、部门、流程
      access_audit_logs: true
      access_tool_calls: true
      access_budget_ledger: true
      access_reputation_scores: true
      
    # 告警权限
    can_issue_alert: true
    alert_levels: ["info", "warning", "critical", "red_alert"]
    red_alert_notifies: ["chairman"]
    
    # 审核权限
    can_review_proposals:
      hiring: true
      termination: true
      
    # 汇报线
    reports_to: "chairman"
    
    # 独立性保障
    independence:
      - "不参与任何策略讨论"
      - "不受 CIO/CRO/Research 管辖"
      - "只向董事长汇报"
      
    # 特殊通信权限
    dm_permissions:
      can_dm_all: true
      receive_from_all: true
      
  # CPO (首席人才官) 权限
  cpo:
    # 招聘提案权限
    can_propose_hiring: true
    hiring_proposal:
      requires_justification: true
      requires_budget_estimate: true
      requires_trial_rules: true
      
    # 终止提案权限
    can_propose_termination: true
    termination_proposal:
      requires_evidence: true
      min_independent_sources: 2
      requires_scorecard: true
      
    # 不能直接执行
    direct_execution: false
    requires_approval_from:
      hiring: ["cgo", "chairman"]
      termination: ["cgo", "chairman"]
      
    # 组织分析权限
    can_analyze:
      org_load: true
      performance: true
      bottlenecks: true
      
    # 绩效评估权限
    can_evaluate:
      scope: "*"  # 可以评估所有 Agent
      
  # CTO* (能力建设官) 权限
  cto_capability:
    # 工具注册表管理
    can_manage_tool_registry: true
    tool_registry_actions:
      - "add_tool"
      - "deprecate_tool"
      - "update_tool_schema"
      
    # 能力缺口报告
    can_publish_capability_report: true
    report_frequency: "weekly"
    
    # 工具需求评估
    can_evaluate_tool_requests: true
    
    # 自动提取权限
    can_extract_from:
      conversations: true
      reports: true
      feedback: true
      
    # 优先级排序权限
    can_prioritize_development: true
    
# ============================================
# 反馈通道权限
# ============================================
feedback_channel:
  # 谁可以提交反馈
  submit:
    allowed: "*"  # 所有 Agent
    categories:
      - "tool_request"
      - "process_improvement"
      - "org_issue"
      - "collaboration"
      - "capability_gap"
      
  # 反馈处理者
  handlers:
    tool_request: "cto_capability"
    process_improvement: "chief_of_staff"
    org_issue: "cpo"
    collaboration: "chief_of_staff"
    capability_gap: "cto_capability"
    
  # Agent 义务
  agent_obligation:
    # 当被董事长问及时必须回答
    on_chairman_ask: "还有什么需要公司支持的吗？"
    required_response_options:
      - "不需要"
      - "需要工具（列出）"
      - "需要人（列出岗位）"
      - "需要制度调整"
    mandatory: true

# ============================================
# 招聘/终止审批流程
# ============================================
hiring_termination:
  # 招聘审批链
  hiring_approval:
    step_1:
      actor: "requesters"
      allowed: ["cio", "cro", "head_of_research", "cto_capability", "*"]
      action: "建议招聘需求"
      to: "cpo"
      
    step_2:
      actor: "cpo"
      action: "分析并创建 HiringProposal"
      output: "HiringProposal"
      
    step_3:
      actor: "cgo"
      action: "审核制度合规性、预算影响"
      can_reject: true
      criteria:
        - "是否符合组织制度"
        - "是否有预算膨胀风险"
        - "是否真有必要"
        
    step_4:
      actor: "chairman"
      action: "最终批准"
      can_reject: true
      auto_approve_threshold: null  # 无自动批准
      
  # 终止审批链
  termination_approval:
    step_1:
      actor: "evidence_sources"
      required_count: 2  # 至少 2 个独立来源
      types:
        - "低绩效评分"
        - "Risk/Skeptic 点名"
        - "预算滥用"
        - "流程违规"
        
    step_2:
      actor: "cpo"
      action: "收集证据、构建 Scorecard、创建 TerminationProposal"
      output: "TerminationProposal"
      
    step_3:
      actor: "cgo"
      action: "验证证据充分性"
      criteria:
        - "是否有 >= 2 个独立来源"
        - "证据是否真实可追溯"
        - "是否存在政治斗争因素"
      can_reject: true
      
    step_4:
      actor: "chairman"
      action: "最终决定"
      options:
        - "批准冻结"
        - "批准终止"
        - "驳回"

# ============================================
# 工具调用约束
# ============================================
tool_constraints:
  # 全局约束
  global:
    # 每日调用上限（按 agent）
    daily_call_limit: 1000
    # 每小时调用上限
    hourly_call_limit: 100
    # 必须产生可追溯的结果
    require_traceability: true
    
  # 强制规则（写入 Agent prompt）
  agent_rules:
    - "当需要事实性数据/曲线/指标时，必须先调用工具获取证据"
    - "不允许凭空编造价格走势或回测结果"
    - "工具调用前先写出「调用理由 + 预期输出」，避免无意义消耗预算"
    - "所有报告只能引用 experiment_id 或 data_version_hash 指向的结果"
    
  # 审计要求
  audit:
    log_all_calls: true
    log_failed_calls: true
    retain_days: 365
